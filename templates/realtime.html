{% extends "base.html" %}

{% block title %}Real-time Monitor - Seismic Advance{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    #map { 
        height: 600px; 
        width: 100%; 
        border-radius: 10px; 
        margin-bottom: 20px; 
    }
    
    .controls { 
        background: var(--color-surface);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .earthquake-list {
        max-height: 400px;
        overflow-y: auto;
        background: var(--color-surface);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
    .container { max-width: 1200px; margin: 0 auto; }
    .earthquake-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .earthquake-item:hover {
        background: #f9f9f9;
    }
    .magnitude {
        padding: 5px 10px;
        border-radius: 15px;
        font-weight: bold;
        color: white;
    }
    .magnitude-1 { background: #1a9850; }
    .magnitude-2 { background: #91cf60; }
    .magnitude-3 { background: #fee08b; }
    .magnitude-4 { background: #fc8d59; }
    .magnitude-5 { background: #d73027; }
    .alert {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px;
        border-radius: 8px;
        background: #ff4444;
        color: white;
        z-index: 1000;
        animation: slideIn 0.5s ease-out;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
</style>
{% endblock %}

{% block content %}
<h1>Real-time Earthquake Monitor</h1>
<div class="card controls">
    <label>Monitoring radius (km): 
        <input type="number" id="radius" value="100" min="10" max="1000">
    </label>
    <button class="button" onclick="updateRadius()">Update</button>
</div>
<div id="map" class="card"></div>
<div class="earthquake-list card" id="earthquakeList"></div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    let map, userMarker, socket, earthquakeMarkers = {};

    function initMap() {
        map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        // Add dark mode styling to the map
        document.querySelector('.leaflet-tile-pane').style.filter = 'invert(0.9) hue-rotate(180deg)';
    }

    function initSocket() {
        socket = io();
        
        socket.on('new_earthquakes', function(earthquakes) {
            earthquakes.forEach(earthquake => {
                addEarthquakeToMap(earthquake);
                addEarthquakeToList(earthquake);
            });
        });

        socket.on('earthquake_alert', function(data) {
            showAlert(data.message);
        });
    }

    function addEarthquakeToMap(earthquake) {
        if (earthquakeMarkers[earthquake.id]) {
            map.removeLayer(earthquakeMarkers[earthquake.id]);
        }

        const marker = L.circle(
            [earthquake.coordinates[1], earthquake.coordinates[0]], {
                color: getColorByMagnitude(earthquake.magnitude),
                fillColor: getColorByMagnitude(earthquake.magnitude),
                fillOpacity: 0.2,  // Reduced opacity for fill
                opacity: 0.4,      // Reduced opacity for stroke
                weight: 1,         // Thin border
                radius: getCircleRadius(earthquake.magnitude),
                className: 'earthquake-marker'  // Added class for custom styling
            }
        ).addTo(map);

        // Add custom CSS for the markers
        const style = document.createElement('style');
        style.textContent = `
            .earthquake-marker {
                transition: all 0.3s ease;
            }
            .earthquake-marker:hover {
                fillOpacity: 0.4;
                opacity: 0.6;
            }
            .leaflet-interactive {
                fill-opacity: 0.2 !important;  /* Make all interactive markers more transparent */
                stroke-opacity: 0.4 !important;
            }
        `;
        document.head.appendChild(style);

        marker.bindPopup(createPopupContent(earthquake));
        earthquakeMarkers[earthquake.id] = marker;
    }

    function createPopupContent(earthquake) {
        return `
            <div class="popup-content">
                <h3>${earthquake.place}</h3>
                <p>
                    <strong>Magnitude:</strong> ${earthquake.magnitude}<br>
                    <strong>Depth:</strong> ${earthquake.depth}km<br>
                    <strong>Distance:</strong> ${earthquake.distance}km<br>
                    <strong>Time:</strong> ${new Date(earthquake.time).toLocaleString()}<br>
                    ${earthquake.tsunami ? '<strong>⚠️ Tsunami Risk</strong><br>' : ''}
                    <strong>Impact Level:</strong> ${earthquake.impact_level}/5
                </p>
                <a href="${earthquake.url}" target="_blank">More info</a>
            </div>`;
    }

    function addEarthquakeToList(earthquake) {
        const list = document.getElementById('earthquakeList');
        const item = document.createElement('div');
        item.className = 'earthquake-item';
        item.innerHTML = `
            <div>
                <strong>${earthquake.place}</strong><br>
                ${new Date(earthquake.time).toLocaleString()}<br>
                ${earthquake.distance}km away
            </div>
            <span class="magnitude magnitude-${earthquake.impact_level}">
                M${earthquake.magnitude.toFixed(1)}
            </span>
        `;
        list.insertBefore(item, list.firstChild);
        
        // Remove old items if too many
        while (list.children.length > 50) {
            list.removeChild(list.lastChild);
        }
    }

    function showAlert(message) {
        const alert = document.createElement('div');
        alert.className = 'alert';
        alert.textContent = message;
        document.body.appendChild(alert);
        
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    function getColorByMagnitude(magnitude) {
        // Added alpha channel for transparency
        if (magnitude >= 7) return 'rgba(215, 48, 39, 0.8)';    // #d73027
        if (magnitude >= 6) return 'rgba(252, 141, 89, 0.8)';   // #fc8d59
        if (magnitude >= 5) return 'rgba(254, 224, 139, 0.8)';  // #fee08b
        if (magnitude >= 4) return 'rgba(145, 207, 96, 0.8)';   // #91cf60
        return 'rgba(26, 152, 80, 0.8)';                        // #1a9850
    }

    function getCircleRadius(magnitude) {
        return Math.pow(2, magnitude) * 1000;
    }

    function updateRadius() {
        const radius = document.getElementById('radius').value;
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                // Remove existing monitoring circle if it exists
                if (window.monitoringCircle) {
                    map.removeLayer(window.monitoringCircle);
                }
                
                // Add new monitoring circle with transparent style
                window.monitoringCircle = L.circle([position.coords.latitude, position.coords.longitude], {
                    color: '#3388ff',
                    fillColor: '#3388ff',
                    fillOpacity: 0.1,    // Very transparent fill
                    opacity: 0.3,         // Semi-transparent border
                    weight: 1,            // Thin border
                    dashArray: '5, 10',   // Dashed line pattern
                    radius: radius * 1000
                }).addTo(map);
                
                socket.emit('register_location', {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    radius: parseInt(radius)
                });
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        initMap();
        initSocket();

        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                map.setView([lat, lng], 8);
                userMarker = L.marker([lat, lng]).addTo(map);
                
                // Add monitoring radius circle
                const radius = parseInt(document.getElementById('radius').value);
                L.circle([lat, lng], {
                    color: '#3388ff',
                    fillColor: '#3388ff',
                    fillOpacity: 0.1,
                    radius: radius * 1000
                }).addTo(map);
                
                socket.emit('register_location', {
                    lat: lat,
                    lng: lng,
                    radius: radius
                });
            });
        }
    });
</script>
{% endblock %}
