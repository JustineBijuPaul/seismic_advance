{% extends "base.html" %}

{% block title %}Risk Assessment - Seismic Advance{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Seismic Risk Assessment Tools</h1>
    
    <div class="row mt-4">
        <!-- Building Vulnerability Assessment -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Building Vulnerability Assessment</h5>
                </div>
                <div class="card-body">
                    <form id="buildingForm">
                        <div class="mb-3">
                            <label>Building Type</label>
                            <select class="form-select" name="building_type" required>
                                {% for code, type in building_types.items() %}
                                <option value="{{ code }}">{{ type.category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>Building Age (years)</label>
                            <input type="number" class="form-control" name="age" required>
                        </div>
                        <div class="mb-3">
                            <label>Building Height (meters)</label>
                            <input type="number" class="form-control" name="height" step="0.1" required>
                        </div>
                        <div class="mb-3">
                            <label>Building Condition</label>
                            <select class="form-select" name="condition" required>
                                <option value="excellent">Excellent</option>
                                <option value="good">Good</option>
                                <option value="fair">Fair</option>
                                <option value="poor">Poor</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Assess Building</button>
                    </form>
                    <div id="buildingResult" class="mt-3 result-container"></div>
                </div>
            </div>
        </div>
        
        <!-- Soil Analysis -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Soil Analysis</h5>
                </div>
                <div class="card-body">
                    <form id="soilForm">
                        <div class="mb-3">
                            <label>Soil Type</label>
                            <select class="form-select" name="soil_type" required>
                                {% for code, type in soil_types.items() %}
                                <option value="{{ code }}">{{ type.description }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>VS30 Value (m/s) (optional)</label>
                            <input type="number" class="form-control" name="vs30">
                        </div>
                        <div class="mb-3">
                            <label>Water Table Depth (m) (optional)</label>
                            <input type="number" class="form-control" name="water_table_depth">
                        </div>
                        <button type="submit" class="btn btn-primary">Analyze Soil</button>
                    </form>
                    <div id="soilResult" class="mt-3 result-container"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hazard Mapping -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Seismic Hazard Mapping</h5>
                </div>
                <div class="card-body">
                    <div id="hazardMap" style="height: 500px;"></div>
                    <div id="hazardControls" class="mt-3">
                        <button id="addPoint" class="btn btn-secondary">Add Point</button>
                        <button id="generateMap" class="btn btn-primary">Generate Hazard Map</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script>
const map = L.map('hazardMap').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let points = [];
let markers = [];

async function handleFormSubmission(url, data, displayFunction) {
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Unknown error occurred');
        }
        
        displayFunction(result);
    } catch (error) {
        showError(error.message);
    }
}

function showError(message) {
    const errorHtml = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.querySelectorAll('.result-container').forEach(container => {
        container.insertAdjacentHTML('afterbegin', errorHtml);
    });
}

// Building Assessment
document.getElementById('buildingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = {
        type: 'building',
        building_type: formData.get('building_type'),
        age: parseInt(formData.get('age')),
        height: parseFloat(formData.get('height')),
        condition: formData.get('condition')
    };
    
    await handleFormSubmission('/risk-assessment', data, displayBuildingResult);
});

// Soil Analysis
document.getElementById('soilForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = {
        type: 'soil',
        soil_type: formData.get('soil_type'),
        vs30: formData.get('vs30') ? parseFloat(formData.get('vs30')) : null,
        water_table_depth: formData.get('water_table_depth') ? 
            parseFloat(formData.get('water_table_depth')) : null
    };
    
    await handleFormSubmission('/risk-assessment', data, displaySoilResult);
});

// Hazard Mapping
document.getElementById('addPoint').addEventListener('click', () => {
    map.once('click', (e) => {
        const marker = L.marker(e.latlng).addTo(map);
        const value = prompt('Enter hazard value (0-100):');
        if (value !== null) {
            points.push({
                location: [e.latlng.lat, e.latlng.lng],
                value: parseFloat(value)
            });
            markers.push(marker);
        }
    });
});

document.getElementById('generateMap').addEventListener('click', async () => {
    if (points.length < 3) {
        showError('Please add at least 3 points');
        return;
    }
    
    const data = {
        type: 'hazard_map',
        locations: points.map(p => p.location),
        values: points.map(p => p.value)
    };
    
    await handleFormSubmission('/risk-assessment', data, displayHazardMap);
});

function displayBuildingResult(result) {
    const container = document.getElementById('buildingResult');
    container.innerHTML = `
        <div class="alert alert-info">
            <h4>Vulnerability Score: ${result.vulnerability_score.toFixed(1)}</h4>
            <p>Risk Level: ${result.risk_level}</p>
            <h5>Recommendations:</h5>
            <ul>
                ${result.recommendations.map(r => `<li>${r}</li>`).join('')}
            </ul>
        </div>
    `;
}

function displaySoilResult(result) {
    const container = document.getElementById('soilResult');
    container.innerHTML = `
        <div class="alert alert-info">
            <h4>Soil Type: ${result.soil_type}</h4>
            <p>Amplification Factor: ${result.amplification_factor.toFixed(2)}</p>
            <p>Hazard Increase: ${result.hazard_increase}</p>
        </div>
    `;
}

function displayHazardMap(result) {
    // Clear existing markers
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    
    // Create contour overlay
    const bounds = [
        [result.bounds.lat_min, result.bounds.lon_min],
        [result.bounds.lat_max, result.bounds.lon_max]
    ];
    
    const overlay = L.imageOverlay(
        createContourImage(result.grid.values),
        bounds,
        {opacity: 0.6}
    ).addTo(map);
    
    map.fitBounds(bounds);
}

function createContourImage(values) {
    // Create a simple visualization using canvas
    const canvas = document.createElement('canvas');
    const size = Math.sqrt(values.length);
    canvas.width = size;
    canvas.height = size;
    
    const ctx = canvas.getContext('2d');
    const imageData = ctx.createImageData(size, size);
    
    values.flat().forEach((value, i) => {
        const intensity = value / 100 * 255;
        imageData.data[i * 4] = intensity;
        imageData.data[i * 4 + 1] = 0;
        imageData.data[i * 4 + 2] = 0;
        imageData.data[i * 4 + 3] = 255;
    });
    
    ctx.putImageData(imageData, 0, 0);
    return canvas.toDataURL();
}
</script>
{% endblock %}
